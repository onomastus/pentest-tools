#!/bin/bash

# Test if there is no argument, ask for IP
if [ "$1" == "" ]; then
	read -p 'Enter target IP: ' target 
else
	target=$1
fi

# Test if provided address is valid
if [[ $target =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    OIFS=$IFS
    IFS='.'
    ip=($target)
    IFS=$OIFS
    [[ ${ip[0]} -le 255 && ${ip[1]} -le 255 && ${ip[2]} -le 255 && ${ip[3]} -le 255 ]]
    stat=$?
else
	echo "Invalid IP, check format."; exit 1
fi
if [ $stat -ne 0 ]; then
	echo "Invalid IP, check format."; exit 1
fi

# Test if host is pingable
ping=`ping -c 1 $target | grep "time=" | cut -d "=" -f 4`
pingTest(){	
	if [ "$ping" == "" ]; then
		read -n1 -p "Ping failed, continue scanning ? [y]/n : " input
		case $input in
			y|Y|''	)	echo -e "\nSkipping ping."	 					;;
			n|N 	)	echo -e "\nGoodbye !"; exit 0					;;
			*		)	echo -e "\nInvalid input, Y or N"; pingTest		;;
		esac
	else
		echo "Ping is $ping"
	fi
}

# Scan open ports using python script
portScan(){
	echo "Scanning ports..."
	openPorts=`./scanlite.py $target`
	for port in $openPorts; do
		if [[ $port -eq 80 || $port -eq 591 || $port -eq 8000 || $port -eq 8008 || $port -eq 8080 ]]; then
			if [ -z "$webPorts" ]; then
				webPorts=$port
			else
				webPorts="$webPort,$port"
			fi
		fi
	done
	openPorts=`echo $openPorts | tr ' ' ','`
	echo -e "Open port(s):\n$openPorts\nPort(s) that may run a webapp:\n$webPorts"
}

# Nmap scan on all open ports with: OS detection, version detection, script scanning, and traceroute
nmapScan(){
	echo "Now performing nmap scan : nmap -T4 -A -Pn -p$openPorts $target"
	nmap -T4 -A -Pn -p$openPorts $target > nmap.txt
	echo "Nmap scan completed."
}

# Scanning web apps
webScan(){
	echo "Starting web scan : nikto, whatweb & gobuster"
	if [ -n "$webPorts" ]; then
		nikto -h $target -port $webPorts > nikto.txt ; echo "Nikto scan completed." &
		IFS=',' read -r -a array <<< "$webPorts"
		for webPort in "${array[@]}"; do
	    	whatweb -v -a 3 $target:$webPort > whatweb$webPort.txt ; echo "whatweb scan for port $webPort completed." &
	    	gobuster dir -w /usr/share/wordlists/dirb/big.txt -u http://$target:$webPort -x php,html,txt,asp,aspx,sh,pl,py > gobuster.txt ; echo "gobuster scan for port $webPort finished." &
		done
	fi
}


pingTest
portScan
nmapScan
webScan
