#!/bin/bash

echo "This script will take some time. Use \"du -s data\" in an other tab to see the size decreasing."

echo "Removing lines with empty passwords"
for file in $(find data -type f); do
	if [ $(basename $file) != "index.html" ]; then
		grep -v ':$' $file > tmp.txt
		mv tmp.txt $file
	fi
done

echo "Removing lines with non-ASCII characters"
for file in $(find data -type f); do
	if [ $(basename $file) != "index.html" ]; then
		perl -nle 'print if m{^[[:ascii:]]+$}' $file > tmp.txt
		mv tmp.txt $file
	fi
done

# This part merges all passwords for a same user into the same line however it takes way too long, probably several days...
#previous=""
#for file in $(find data -type f); do
#	if [ $(basename $file) != "index.html" ]; then
#		echo "" > tmp.txt
#		for line in $(cat $file); do
#			address=$(echo $line | cut -d: -f 1)
#			password=$(echo $line | cut -d: -f 2)
#			if [ "$address" == "$previousAddress" ]; then
#				head -n -1 tmp.txt > tmp ; mv tmp tmp.txt
#				if [ "$password" == "$previousPassword" ]; then
#					echo $line >> tmp.txt
#				else
#					#Separator for passwords is tilde, one of the least used characters in passwords : https://www.wired.com/2013/08/the-rarity-of-the-ampersand/
#					line="$line~$previousPassword"
#					echo $line >> tmp.txt
#				fi
#			else
#				echo $line >> tmp.txt
#			fi
#			previousLine=$line
#			previousAddress=$address
#			previousPassword=$password
#		done
#		mv tmp.txt $file
#	fi
#done
